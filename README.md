# Latest Console newsletter - web version

The web version of the latest Console newsletter.

### Links

* Production website: https://console.dev/latest
* Test environment: https://home-latest-test.consoledev.workers.dev
* [Deploy action](https://github.com/consoledotdev/home-latest/actions?query=workflow%3ADeploy)
* [Interesting tools source Google Sheet](https://docs.google.com/spreadsheets/d/1VGVFXtfOAhZqPdY30mrD_4towCj6lCdhuwr35vp4xgM/edit)
* [Beta programs source Google Sheet](https://docs.google.com/spreadsheets/d/10SJbUuMWgc-ACOzNydXL16vE_fDwJIP92G4_L8XUhrQ/edit)

### Build process

1. Content is extracted from the source sheets by the
   [gsheet.action](https://github.com/marketplace/actions/gsheet-action) GitHub
   Action.
2. The JSON is merged into the static HTML:
   [public/index.html](public/index.html)
3. The static HTML is deployed to [Cloudflare Workers
   Sites](https://developers.cloudflare.com/workers/platform/sites) using the
   [Wranger GitHub Action](https://github.com/cloudflare/wrangler-action).

## Setup

1. Install [Cloudflare
  Wrangler](https://developers.cloudflare.com/workers/cli-wrangler/install-update)
  for deployment and managing the
  [static worker site](https://developers.cloudflare.com/workers/platform/sites).
2. Set up Python virtual environment:

```shell
python3 -m venv .venv
source .venv/bin/activate
pip3 install -r requirements.txt
```

## Site deployment

### Local dev

`wrangler preview --watch`

### Live testing

`wrangler publish --env test`

Available at: https://home-latest-test.consoledev.workers.dev

### Production

Automatic deployment: [run
workflow](https://github.com/consoledotdev/home-latest/actions?query=workflow%3ADeploy)
and enter `production` as the deployment environment.

Manual deployment (you must build the HTML before deploying):

`wrangler publish --env production`

## Build HTML

The `build_html.py` script is triggered as part of the deployment process. It
takes as a parameter a JSON files containing the source lists, then outputs it
as a static HTML page. The goal is to have the site serve static HTML rather
than, for example, load a JSON file on demand. This is purely for better
performance on page load times.

Uses the [Python Jinja2 template
engine](https://jinja.palletsprojects.com/en/2.11.x/templates/).

An example of the expected JSON files format can in the root. This file in
generated by the gsheet.action.

```shell
usage: build_html.py [-h] --tools-json TOOLS_JSON --beta-json BETA_JSON --template TEMPLATE --output OUTPUT [--ignore-date IGNORE_DATE]

optional arguments:
  -h, --help            show this help message and exit
  --tools-json TOOLS_JSON
                        Path to the file containing the interesting tools list as a JSON object
  --beta-json BETA_JSON
                        Path to the file containing the beta list as a JSON object
  --template TEMPLATE   Path to the file containing the table template within the templates/ directory
  --output OUTPUT       Path to the location of the output file (will be created if it does not exist, overwritten if it does)
  --ignore-date IGNORE_DATE
                        Output every item in the JSON regardless of the date. Used for testing
```

## Authentication

### Google Service Account

The [Google Service
Account](https://console.cloud.google.com/iam-admin/serviceaccounts/details/105013685991318651001?orgonly=true&project=console-home-latest&supportedpurview=project)
is used by
[gsheet.action](https://github.com/marketplace/actions/gsheet-action) to pull
the contents of the beta programs source Google Sheet. The [Google Sheets
API](https://console.cloud.google.com/apis/api/sheets.googleapis.com/credentials?project=console-home-latest)
is enabled for the Service Account.

## Secrets

* `CF_API_TOKEN` - [Cloudflare API
  token](https://dash.cloudflare.com/profile/api-tokens) to deploy.
* `GSHEET_CLIENT_EMAIL` - email of the Google Service Account.
* `GSHEET_PRIVATE_KEY` - private key of the Google Service Account. Download
  JSON then extract private key component.
